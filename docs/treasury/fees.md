# Protocol Fees

The protocol implements several types of fees to sustain its operations, reward stakeholders, and manage resources. Fees are configurable and can vary per ALM vault or even per user in some cases.
NB: M.BPS is 1e4 (100_00) and M.PREC_BPS is 1e8 (cf. LibMaths.sol)

## Fee Types

### 1. Action Fees (Entry/Exit)

*   **Description**: These fees are applied when users deposit funds into (Entry Fee) or withdraw funds from (Exit Fee) an ALM vault. They are designed to cover the operational costs associated with user actions, such as gas for rebalancing or potential impermanent loss mitigation.
*   **Calculation**:
    *   Action fees are specified in basis points (BPS).
    *   When depositing, the entry fee is typically *subtracted* from the user's deposited amount, meaning the net amount is added to the vault's liquidity.
        *   `netAmount = grossAmount - (grossAmount * entryFeeBp / M.BPS)`
    *   When withdrawing, the exit fee is typically *subtracted* from the amount the user is entitled to, meaning the user receives a net amount after the fee.
        *   `netAmountToUser = grossEntitlement - (grossEntitlement * exitFeeBp / M.BPS)`
*   **Implementation**:
    *   The core logic for applying these fees is in `LibALMBase.applyActionFees()`.
    *   Functions like `LibALMBase.sharesToAmounts()` and `LibALMBase.amountsToShares()` use `applyActionFees()` to calculate net amounts and fee portions.
*   **Configuration**:
    *   Each ALM vault has a default `Fees` struct (`ALMVault.fees`) which includes `entry` and `exit` fee basis points. These are set via `LibTreasury.setAlmVaultFees()` (callable by managers).
    *   **Custom User Fees**: The protocol supports overriding these default vault fees on a per-user basis.
        *   `LibTreasury.setCustomFees(address _user, Fees calldata _fees)` allows a manager to set specific `Fees` (including entry and exit BPS) for a particular user. These custom fees are stored in `S.tres().customFees[_user]`.
        *   When calculating action fees, the system first checks if custom fees are set for the `msg.sender` (the user initiating the action) for the specific vault via `LibTreasury.almFees(address _user, ALMVault storage _vault)`. This function intelligently returns the user's custom fees if `updatedAt > 0`, otherwise, it falls back to the vault's default fees.
        *   This allows for tiered fee structures, VIP users, or promotional fee waivers.
*   **Exemption/Reduction**: A user can be effectively exempt or have reduced fees if their custom fee for a specific action type (entry/exit) is set to 0 or a lower BPS value.

### 2. Performance Fees

*   **Description**: Performance fees are charged on the profits generated by the ALM vault, specifically from the Liquidity Provider (LP) fees collected from the underlying DEX pools where the vault's assets are deployed. This fee incentivizes the protocol and its managers to maximize returns.
*   **Calculation**:
    *   Calculated as a percentage (basis points) of the collected LP fees (both token0 and token1).
    *   `performanceFee_token0 = collectedLpFee_token0 * vault.fees.perf / M.BPS`
    *   `performanceFee_token1 = collectedLpFee_token1 * vault.fees.perf / M.BPS`
*   **Implementation**:
    *   `LibTreasury.previewAlmPerfFees()` calculates the potential performance fees.
    *   `LibTreasury.accrueAlmFees()` is called (e.g., during rebalances or when `burnRanges` collects fees) to sum up performance and management fees. These are added to the vault's `pendingFees` and `accruedFees` for each token.
*   **Collection**:
    *   Accumulated `pendingFees` are transferred to the `S.tres().collector` address when `LibTreasury.collectAlmFees()` is called.
*   **Configuration**:
    *   The performance fee ( `perf` in BPS) is part of the `Fees` struct, configurable per vault via `LibTreasury.setAlmVaultFees()` and per user via `LibTreasury.setCustomFees()`. The `LibTreasury.almFees()` function handles the override logic.

### 3. Management Fees

*   **Description**: Management fees are time-based fees charged on the total assets managed by an ALM vault. They are intended to cover ongoing operational and development costs of the protocol.
*   **Calculation**:
    *   Calculated as an annualized percentage (basis points) of the vault's LP balances (excluding cash).
    *   The fee accrues proportionally to the time elapsed since the last accrual.
    *   `elapsedTimeFractionOfYear = (block.timestamp - lastAccruedAt) / SECONDS_IN_YEAR`
    *   `effectiveRate = vault.fees.mgmt * elapsedTimeFractionOfYear`
    *   `managementFee_token0 = lpBalance0 * effectiveRate / M.BPS` (adjusting for BPS scaling)
    *   `managementFee_token1 = lpBalance1 * effectiveRate / M.BPS` (adjusting for BPS scaling)
    *   The actual calculation in `LibTreasury.previewAlmMgmtFees()` is:
        `durationBp = elapsed.mulDivUp(M.PREC_BPS, M.SEC_PER_YEAR)`
        `scaledRate = uint256(_vault.fees.mgmt).mulDivUp(durationBp, M.BPS)`
        `mgmtFee0 = balance0.mulDivUp(scaledRate, M.PREC_BPS)`
*   **Implementation**:
    *   `LibTreasury.previewAlmMgmtFees()` calculates potential management fees based on LP balances and time elapsed.
    *   `LibTreasury.accrueAlmFees()` includes these in the `pendingFees` and `accruedFees`. The vault's `timePoints.accruedAt` is updated.
*   **Collection**:
    *   Collected alongside performance fees via `LibTreasury.collectAlmFees()`.
*   **Configuration**:
    *   The management fee ( `mgmt` in BPS) is part of the `Fees` struct, configurable per vault via `LibTreasury.setAlmVaultFees()` and per user via `LibTreasury.setCustomFees()`. `LibTreasury.almFees()` handles the override.

### 4. Flashloan Fees (Future Implementation)

*   **Description**: While not yet implemented, the protocol is designed to potentially support flashloans in the future. Flashloan fees would be charged to users who borrow assets from the vaults for a single transaction, with the condition that the loan (plus the fee) is repaid by the end of that same transaction.
*   **Calculation**:
    *   Typically a small percentage (basis points) of the loaned amount.
    *   `flashloanFee = loanedAmount * vault.fees.flash / M.BPS`
*   **Implementation**:
    *   This functionality is not present in the current codebase but is anticipated. The `Fees` struct already includes a `flash` field.
*   **Configuration**:
    *   The flashloan fee ( `flash` in BPS) is part of the `Fees` struct. It would be configurable similarly to other fees via `LibTreasury.setAlmVaultFees()` and potentially `LibTreasury.setCustomFees()`.

## Fee Collection and Treasury

*   **Pending Fees**: All collected action fees (entry/exit), accrued performance fees, and accrued management fees are initially recorded in the `ALMVault.pendingFees[tokenAddress]` mapping.
*   **Accrued Fees**: `ALMVault.accruedFees` keeps a running total of all fees ever accrued for accounting purposes.
*   **Collector Address**: The `S.tres().collector` address is the designated recipient of all collected protocol fees. It can be set via `LibTreasury.setCollector()`.
*   **Collection Process**: The `LibTreasury.collectAlmFees(ALMVault storage _vault)` function is responsible for:
    1.  Reading the amounts from `_vault.pendingFees` for token0 and token1.
    2.  Transferring these fee amounts from the vault contract to the `collector` address.
    3.  Resetting `_vault.pendingFees` for the collected tokens to zero.
    4.  Updating `_vault.timePoints.collectedAt`.

## Fee Validation

All fee configurations (entry, exit, management, performance, flash) are validated against maximum allowable BPS values (e.g., `MAX_ENTRY_FEE_BPS = 5000`, i.e., 50%) to prevent accidental or malicious setting of excessively high fees. This validation occurs in `LibTreasury.validateFees()`.

---
